local Gacha = {}
Gacha.__index = Gacha

Gacha.Positions = {

    ["5"] = {

        Size = UDim2.new(0.558, 0, 0.798, 0);
        ScaledSize = UDim2.new(0.568, 0, 0.812, 0);

        Positions = {

            UDim2.new(-0.743640661, 0, 0.50877279, 0);
            UDim2.new(-0.124811858, 0, 0.506795704, 0);
            UDim2.new(0.499948144, 0, 0.506795704, 0);
            UDim2.new(1.12075436, 0, 0.506795704, 0);
            UDim2.new(1.74551451, 0, 0.504818618, 0);

        }

    };

    ["10"] = {

        Size = UDim2.new(0.513, 0,0.734, 0);
        ScaledSize = UDim2.new(0.536, 0, 0.765, 0);

        Positions = {

            UDim2.new(-0.729801059, 0, 0.146965563, 0);
            UDim2.new(-0.110972233, 0, 0.144988477, 0);
            UDim2.new(0.513787806, 0, 0.144988477, 0);
            UDim2.new(1.13459396, 0, 0.144988477, 0);
            UDim2.new(1.75935411, 0, 0.143011391, 0);
            UDim2.new(-0.729801059, 0, 1.00897634, 0);
            UDim2.new(-0.110972233, 0, 1.00699925, 0);
            UDim2.new(0.513787806, 0, 1.00699925, 0);
            UDim2.new(1.13459396, 0, 1.00699925, 0);
            UDim2.new(1.75935411, 0, 1.00502217, 0);

        }

    };

    ["15"] = {

        Size = UDim2.new(0.417, 0, 0.595, 0);
        ScaledSize = UDim2.new(0.429, 0, 0.613, 0);

        Positions = {

            UDim2.new(-0.406845421, 0, -0.068715401, 0);
            UDim2.new(0.046051845, 0, -0.0702770948, 0);
            UDim2.new(0.503634155, 0, -0.0718388483, 0);
            UDim2.new(0.951846242, 0, -0.068715401, 0);
            UDim2.new(1.40474379, 0, -0.0718388483, 0);
            UDim2.new(1.40474367, 0, 0.559094012, 0);
            UDim2.new(0.951846123, 0, 0.562217355, 0);
            UDim2.new(0.503634512, 0, 0.559094012, 0);
            UDim2.new(0.046051804, 0, 0.560655594, 0);
            UDim2.new(-0.40864715, 0, 0.562217355, 0);
            UDim2.new(-0.40864715, 0, 1.19824016, 0);
            UDim2.new(0.046051804, 0, 1.19667828, 0);
            UDim2.new(0.503634512, 0, 1.19511676, 0);
            UDim2.new(0.951846123, 0, 1.19824016, 0);
            UDim2.new(1.40474367, 0, 1.19511676, 0);

        }

    };

    ["20"] = {

        Size = UDim2.new(0.324, 0, 0.463, 0);
        ScaledSize = UDim2.new(0.344, 0,0.491, 0);

        Positions = {

            UDim2.new(-0.011917606, 0, 0.0317967236, 0);
            UDim2.new(0.340711474, 0, 0.0305807758, 0);
            UDim2.new(0.696988046, 0, 0.0293647163, 0);
            UDim2.new(1.04596937, 0, 0.0317967236, 0);
            UDim2.new(1.39859843, 0, 0.0293647163, 0);
            UDim2.new(1.39859843, 0, 0.520613313, 0);
            UDim2.new(1.04596901, 0, 0.52304548, 0);
            UDim2.new(0.696988404, 0, 0.520613372, 0);
            UDim2.new(0.340711474, 0, 0.521829367, 0);
            UDim2.new(-0.0133203128, 0, 0.523045421, 0);
            UDim2.new(-0.0133203128, 0, 1.0182569, 0);
            UDim2.new(0.340711474, 0, 1.01704097, 0);
            UDim2.new(0.696988404, 0, 1.01582515, 0);
            UDim2.new(1.04596901, 0, 1.01825702, 0);
            UDim2.new(1.39859843, 0, 1.01582515, 0);
            UDim2.new(-0.377276629, 0, 0.0317740142, 0);
            UDim2.new(-0.734941542, 0, 1.01792467, 0);
            UDim2.new(-0.376862884, 0, 0.52302593, 0);
            UDim2.new(1.76487279, 0, 1.01373553, 0);
            UDim2.new(-0.376139164, 0, 1.01670909, 0);

        }

    };

    ["25"] = {

        Size = UDim2.new(0.324, 0, 0.463, 0);
        ScaledSize = UDim2.new(0.344, 0,0.491, 0);

        Positions = {

           UDim2.new(1.39499485, 0, 0.0323353633, 0);
           UDim2.new(1.04236543, 0, 0.0347674787, 0);
           UDim2.new(0.693384886, 0, 0.0323353633, 0);
           UDim2.new(0.337107956, 0, 0.0335513093, 0);
           UDim2.new(-0.0169238411, 0, 0.0347673707, 0);
           UDim2.new(2.11570048, 0, 0.0302602109, 0);
           UDim2.new(-1.0844835, 0, 0.0341615379, 0);
           UDim2.new(-0.380466431, 0, 0.034747906, 0);
           UDim2.new(1.75406218, 0, 0.0353777073, 0);
           UDim2.new(-0.731338024, 0, 0.0359633043, 0);
           UDim2.new(0.337107956, 0, 0.527234614, 0);
           UDim2.new(1.39499485, 0, 0.52601862, 0);
           UDim2.new(0.693384886, 0, 0.526018679, 0);
           UDim2.new(-0.0169238411, 0, 0.528450668, 0);
           UDim2.new(2.11570048, 0, 0.523943543, 0);
           UDim2.new(-1.0844835, 0, 0.527844846, 0);
           UDim2.new(-0.380466431, 0,0.528431237, 0);
           UDim2.new(1.75406218, 0, 0.529061079, 0);
           UDim2.new(-0.731338024, 0,0.529646635, 0);
           UDim2.new(1.04236543, 0, 0.528450847, 0);
           UDim2.new(0.162336856, 0,1.01731443, 0);
           UDim2.new(1.22022378, 0, 1.01609838, 0);
           UDim2.new(0.518613815, 0, 1.0160985, 0);
           UDim2.new(-0.191694945, 0,1.01853049, 0);
           UDim2.new(0.867594302, 0, 1.01853061, 0);

        }

    };

    ["30"] = {

        Size = UDim2.new(0.324, 0, 0.463, 0);
        ScaledSize = UDim2.new(0.344, 0,0.491, 0);

        Positions = {

            UDim2.new(1.41121078, 0, 0.0197230149, 0);
            UDim2.new(1.05858135, 0, 0.0221551321, 0);
            UDim2.new(0.709600747, 0, 0.0197230149, 0);
            UDim2.new(0.353323847, 0, 0.0209389627, 0);
            UDim2.new(-0.000707965461, 0, 0.0221550222, 0);
            UDim2.new(2.13191628, 0, 0.0176478624, 0);
            UDim2.new(-1.0682677, 0, 0.0215491913, 0);
            UDim2.new(-0.364250541,0, 0.0221355557, 0);
            UDim2.new(1.7702781, 0,0.0227653608, 0);
            UDim2.new(-0.715122163,0, 0.0233509559, 0);
            UDim2.new(0.353323847, 0, 0.514622271, 0);
            UDim2.new(1.41121078, 0, 0.513406277, 0);
            UDim2.new(0.709600747, 0, 0.513406336, 0);
            UDim2.new(-0.000707965461, 0, 0.515838325, 0);
            UDim2.new(2.13191628, 0, 0.511331201, 0);
            UDim2.new(-1.0682677, 0, 0.515232503, 0);
            UDim2.new(-0.364250541,0, 0.515818894, 0);
            UDim2.new(1.7702781, 0,0.516448736, 0);
            UDim2.new(-0.715122163,0, 0.517034292, 0);
            UDim2.new(1.05858135, 0, 0.515838504, 0);
            UDim2.new(-0.711518645,0, 1.02271962, 0);
            UDim2.new(0.346368223, 0, 1.02150369, 0);
            UDim2.new(-0.355241716,0, 1.02150381, 0);
            UDim2.new(-1.06915402, 0, 1.03114295, 0);
            UDim2.new(-0.00626119552, 0, 1.02393591, 0);
            UDim2.new(0.718195736, 0, 1.02393579, 0);
            UDim2.new(1.07583129, 0, 1.01551259, 0);
            UDim2.new(1.43210828, 0, 1.01429677, 0);
            UDim2.new(1.78108859, 0, 1.01672888, 0);
            UDim2.new(2.13371801, 0, 1.01429665, 0);

        }

    };
    
}

local list = {

    Positions = {}

}

for _, v in ipairs(game.StarterGui.Root.Gacha.Batch:GetChildren()) do
    table.insert(list.Positions, v.Position)
end

print(list)

type Card = {

    Front : {

        Icon : ImageLabel;
        ItemName : TextLabel;
        ItemRarity : TextLabel;
        ItemChance : TextLabel;

    };
    
    Back : ImageButton


}

local Playergui = game.Players.LocalPlayer.PlayerGui.Root
local CardPacks = workspace.Map.CardPacks;

local Camera : Camera? = workspace.CurrentCamera;
local Tweenservice = game:GetService("TweenService");

local UIS = game:GetService("UserInputService")
local Rep = game:GetService("ReplicatedStorage")
local Configs = require(script.Parent.Parent.Configs)

local Net = require(Rep.Packages.BridgeNet2)
local Bridge = Net.ReferenceBridge("ServerCommunication");

function Gacha.New()

    local self = {}

    self._name = "Gacha";
    self._GUI = Playergui.Gacha;

    self._FXConnections = {}
    self._isopening = false;

    return setmetatable(self, Gacha)

end

function Gacha:Parse(Action , Kwargs)
    if Action == "PlayAnimation" then
        self:OpenAnimation(Kwargs)
    end

    if Action == "Update" then
        self:Update(Kwargs)
    end
end

function Gacha:Update(Kwargs)
    
    self._GUI.Prompt.Prompt.Text = "Would you like to open 5 Cards or "..tostring(Kwargs.Max).." Cards?"
    self._GUI.Prompt.Amounts.Max.Text = tostring(Kwargs.Max).." Cards"

end

function Gacha:Reset()
    for _,v in ipairs(self._GUI.Batch:GetChildren()) do
        v:Destroy()
        
    end

    for _,v  in ipairs(self._FXConnections) do
        if v then v:Disconnect() end
    end 

    self._blur:Destroy()

    Tweenservice:Create(workspace.CurrentCamera, TweenInfo.new(.25), {FieldOfView = 70}):Play()
end

function Gacha:OpenAnimation(kwargs)

    print(kwargs)

    self._isopening = true;
    require(script.Parent.PlayerHUD).HUD:Hide()
    
    local list = kwargs.List
    local Times = Gacha.Positions[tostring(kwargs.Times)];
    print(Times, tostring(kwargs.Times))
    local Batch = self._GUI.Batch;

    Tweenservice:Create(workspace.CurrentCamera, TweenInfo.new(.25), {FieldOfView = 80}):Play()
    
    self._blur = Instance.new("BlurEffect")
    self._blur.Size = 10;
    self._blur.Parent = workspace.CurrentCamera;

    for i = 1, #Times.Positions do

        print(list[i])
        
        local newCard : Card = self._GUI.Card:Clone()
        newCard.Parent = Batch;

        local config =  Configs[kwargs.Container][list[i]]

        newCard.Front.ItemChance.Text = config.Chance;
        newCard.Front.ItemName.Text = config.DisplayName;
        newCard.Front.ItemRarity.Text = config.Rarity;
        newCard.Front.Icon.Image = config.Icon;

        newCard.Size = UDim2.new(0, 0, 0, 0)

        newCard.Visible = true;
        newCard.Position = Times.Positions[i]
        
        Tweenservice:Create(newCard, TweenInfo.new(0.2), {Size = Times.Size}):Play()

        task.wait(0.1)

    end

    -- // create hover and click connections

    for _, v : Card in ipairs(Batch:GetChildren()) do

        local conn1 = v.MouseEnter:Connect(function()
            Tweenservice:Create(v, TweenInfo.new(.1), {Size = Times.ScaledSize}):Play()
        end)

        local conn2 = v.MouseLeave:Connect(function()
            Tweenservice:Create(v, TweenInfo.new(.1), {Size = Times.Size}):Play()
        end)

        local conn3 = v.Back.Activated:Connect(function()

            for _, c in ipairs(self._FXConnections) do
                if c then c:Disconnect() end
            end

            for _, card : Card in ipairs(Batch:GetChildren()) do

                Tweenservice:Create(card, TweenInfo.new(.1), {Size = UDim2.new(0 , 0, 0, 0)}):Play()
    
                task.wait(.1)
                
                card.Back.Visible = false;
                card.Front.Visible = true
    
                Tweenservice:Create(card, TweenInfo.new(.1), {Size = Times.ScaledSize}):Play()
    
            end
    
            task.wait(2)
    
            self:Reset()
            self._isopening = false;
            require(script.Parent.PlayerHUD).HUD:Unhide()

        end)

        table.insert(self._FXConnections, conn1)
        table.insert(self._FXConnections, conn2)
        table.insert(self._FXConnections, conn3)

    end

end

function Gacha:Fire(Cotnainer, t)

    self._GUI.Prompt.Visible = false;

    Bridge:Fire({

        Request = "Gacha";
        Action = "Process";
        Arguments = {
            Container = Cotnainer;
            Times = t
        }

    })
end

function Gacha:Deploy()
    
    for _, v in ipairs(CardPacks:GetChildren()) do

        v.Activator.UIOffset = Vector2.new(100000, 100000)

        v.Activator.Triggered:Connect(function()
            if self._isopening == false then

                self._GUI.Prompt.Visible = true;
                self._currentContainer = v.Name;

            end
        end)

        v.Activator.PromptShown:Connect(function(playerWhoTriggered)
            Tweenservice:Create(v._R, TweenInfo.new(0.15), {Size = UDim2.new(6, 0, 7, 0)}):Play() 
        end)

        v.Activator.PromptHidden:Connect(function(playerWhoTriggered)
            Tweenservice:Create(v._R, TweenInfo.new(0.15), {Size = UDim2.new(0, 0, 0, 0)}):Play()
        end)
    end

    for _, v in ipairs(self._GUI.Prompt.Amounts:GetChildren()) do
        v.Activated:Connect(function()
            print(tonumber(v.Name))
            self:Fire(self._currentContainer, v.Name)
        end)
    end

end

return Gacha